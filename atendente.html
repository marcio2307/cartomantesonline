<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Cliente Chat</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{
  height:100%;
  font-family:"Segoe UI",sans-serif;
  background-color:#f2f2f2;
  overflow:hidden;
}
.chat-container{
  display:flex;
  flex-direction:column;
  height:100vh;
  background:#fff;
  width:100%;
  max-width:600px;
  margin:auto;
  border-radius:0;
}
.chat-header{
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:var(--theme-color,#00bfa5);
}
.chat-header-left{
  display:flex;
  align-items:center;
  gap:8px;
}
.chat-header img{
  width:42px;
  height:42px;
  border-radius:50%;
  border:2px solid #fff;
  object-fit:cover;
  cursor:pointer;
}
.color-options{
  display:flex;
  gap:4px;
}
.color-btn{
  width:18px;
  height:18px;
  border-radius:50%;
  border:2px solid #fff;
  cursor:pointer;
}
.messages{
  flex:1;
  overflow-y:auto;
  padding:12px;
  background:#eef3f7;
  display:flex;
  flex-direction:column;
  gap:8px;
  scroll-behavior:smooth;
}
.message{
  display:flex;
  align-items:flex-end;
  gap:6px;
  max-width:80%;
}
.message.sent{
  align-self:flex-end;
  flex-direction:row-reverse;
}
.message img{
  width:30px;
  height:30px;
  border-radius:50%;
  object-fit:cover;
}
.bubble{
  position:relative;
  padding:10px 14px;
  border-radius:15px;
  font-size:15px;
  line-height:1.4;
  word-wrap:break-word;
}
.message.sent .bubble{
  background:var(--theme-color,#00bfa5);
  color:#fff;
  border-bottom-right-radius:5px;
}
.message.received .bubble{
  background:#fff;
  border-bottom-left-radius:5px;
}
.lixeira{
  position:absolute;
  top:-8px;
  right:-8px;
  background:var(--theme-color,#00bfa5);
  color:#fff;
  width:22px;
  height:22px;
  border-radius:50%;
  font-size:13px;
  display:none;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  opacity:0;
  transition:opacity .3s ease;
}
.bubble:hover .lixeira{display:flex;opacity:1;}
.input-area{
  display:flex;
  align-items:center;
  background:var(--theme-color,#00bfa5);
  padding:10px;
}
.input-area input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
  outline:none;
  font-size:15px;
}
.input-area button{
  border:none;
  margin-left:8px;
  padding:10px 12px;
  border-radius:50%;
  background:#fff;
  color:var(--theme-color,#00bfa5);
  font-size:18px;
  cursor:pointer;
}
#micBtn.recording{
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%{transform:scale(1);background:var(--theme-color,#00bfa5);}
  50%{transform:scale(1.2);background:red;}
  100%{transform:scale(1);background:var(--theme-color,#00bfa5);}
}

/* Responsivo para telas pequenas */
@media (max-width:480px){
  .chat-header img{width:38px;height:38px;}
  .message img{width:26px;height:26px;}
  .bubble{font-size:14px;padding:8px 12px;}
  .color-btn{width:16px;height:16px;}
  .input-area input{font-size:14px;}
}
</style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header" id="chatHeader">
    <div class="chat-header-left">
      <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/6009/6009864.png" alt="Perfil">
      <h3>Cliente</h3>
    </div>
    <div class="color-options">
      <div class="color-btn" style="background:#6a5acd;" data-color="#6a5acd"></div>
      <div class="color-btn" style="background:#ff69b4;" data-color="#ff69b4"></div>
      <div class="color-btn" style="background:#00bfa5;" data-color="#00bfa5"></div>
      <div class="color-btn" style="background:#ffa500;" data-color="#ffa500"></div>
      <div class="color-btn" style="background:#4caf50;" data-color="#4caf50"></div>
      <div class="color-btn" style="background:#000000;" data-color="#000000"></div>
      <div class="color-btn" style="background:#ff0000;" data-color="#ff0000"></div>
    </div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Digite...">
    <button id="micBtn">üé§</button>
    <button id="sendBtn" style="display:none;">‚û§</button>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none"/>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyCJhW7_koTgk41BMRP_rS5C9QMG2hBk0LU",authDomain:"coletivo2025-9de23.firebaseapp.com",databaseURL:"https://coletivo2025-9de23-default-rtdb.firebaseio.com/",projectId:"coletivo2025-9de23",storageBucket:"coletivo2025-9de23.appspot.com",messagingSenderId:"431833480939",appId:"1:431833480939:web:0ecb3777dc1c624f7b43d3"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database().ref("chatRealtimeTemp");

const header=document.getElementById("chatHeader"),
colorBtns=document.querySelectorAll(".color-btn"),
profilePic=document.getElementById("profilePic"),
fileInput=document.getElementById("fileInput"),
messages=document.getElementById("messages"),
input=document.getElementById("messageInput"),
micBtn=document.getElementById("micBtn"),
sendBtn=document.getElementById("sendBtn");

profilePic.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    profilePic.src=r.result;
    db.child("fotoPerfilCliente").set(r.result);
  };
  r.readAsDataURL(f);
};

let fotoAtendente="https://cdn-icons-png.flaticon.com/512/6009/6009864.png";
db.child("fotoPerfilAtendente").on("value",s=>{
  if(s.val())fotoAtendente=s.val();
});

function setTheme(c){
  document.documentElement.style.setProperty("--theme-color",c);
  header.style.background=c;
}
const saved=localStorage.getItem("chatColorCliente");
if(saved)setTheme(saved);
colorBtns.forEach(b=>b.onclick=()=>{
  setTheme(b.dataset.color);
  localStorage.setItem("chatColorCliente",b.dataset.color);
});

function sendMessage(){
  const t=input.value.trim();
  if(t){
    db.push({sender:"cliente",type:"text",text:t});
    input.value="";
    micBtn.style.display="block";
    sendBtn.style.display="none";
  }
}
sendBtn.onclick=sendMessage;
input.oninput=()=>{
  sendBtn.style.display=input.value.trim()?"block":"none";
  micBtn.style.display=input.value.trim()?"none":"block";
};
input.onkeypress=e=>{
  if(e.key==="Enter"){e.preventDefault();sendMessage();}
};

let mediaRecorder,chunks=[];
micBtn.onclick=async()=>{
  if(!mediaRecorder||mediaRecorder.state==="inactive"){
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(s);
    micBtn.classList.add("recording");
    chunks=[];
    mediaRecorder.start();
    mediaRecorder.ondataavailable=e=>chunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const b=new Blob(chunks,{type:"audio/webm"});
      const r=new FileReader();
      r.onloadend=()=>db.push({sender:"cliente",type:"audio",data:r.result});
      r.readAsDataURL(b);
      micBtn.classList.remove("recording");
    };
  }else mediaRecorder.stop();
};

db.on("child_added",s=>{
  const m=s.val();
  if(m.type)addMessage(s.key,m);
});
db.on("child_removed",s=>{
  const el=document.getElementById(s.key);
  if(el)el.remove();
});

function addMessage(id,m){
  const d=document.createElement("div");
  d.classList.add("message",m.sender==="cliente"?"sent":"received");
  d.id=id;
  const img=document.createElement("img");
  img.src=m.sender==="cliente"?profilePic.src:fotoAtendente;
  const b=document.createElement("div");
  b.classList.add("bubble");
  if(m.type==="text")
    b.innerHTML=`${m.text}<div class='lixeira' onclick="deleteMsg('${id}')">üóëÔ∏è</div>`;
  else if(m.type==="audio")
    b.innerHTML=`<audio controls style="width:200px"><source src="${m.data}" type="audio/webm"></audio><div class='lixeira' onclick="deleteMsg('${id}')">üóëÔ∏è</div>`;
  d.appendChild(img);
  d.appendChild(b);
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

function deleteMsg(id){
  db.child(id).remove();
}
</script>
</body>
</html>

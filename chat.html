<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat h√≠brido ‚Äî gpt-4o-mini (online/offline)</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--panel-2:#111827;--text:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937;
    --bubble-user:#1f2937;--bubble-assistant:#0a0f1d;
  }
  [data-theme="light"]{
    --bg:#f7f7fb;--panel:#fff;--panel-2:#f3f4f6;--text:#111827;--muted:#6b7280;--accent:#16a34a;--border:#e5e7eb;
    --bubble-user:#e5e7eb;--bubble-assistant:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;height:100vh}
  header{display:flex;align-items:center;gap:.75rem;padding:.9rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2))}
  .title{font-weight:700}
  .spacer{flex:1}
  .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.45rem .7rem;border-radius:.6rem;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0b0b}
  .messages{flex:1;overflow:auto;padding:1rem;scroll-behavior:smooth}
  .empty{text-align:center;opacity:.8;margin-top:18vh}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:.6rem 0;align-items:flex-start;margin-bottom:1rem}
  .msg .avatar{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:700}
  .msg.user .avatar{background:#334155}
  .msg.assistant .avatar{background:#063b2d}
  .bubble{grid-column:2/span 1;padding:.8rem 1rem;border-radius:1rem;background:var(--bubble-assistant);border:1px solid var(--border);white-space:pre-wrap}
  .msg.user .bubble{background:var(--bubble-user)}
  .meta{grid-column:2/span 1;color:var(--muted);font-size:.82rem;margin-top:.22rem;display:flex;gap:.6rem;align-items:center}
  .composer{border-top:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));padding:.8rem;display:grid;gap:.6rem}
  textarea{flex:1;min-height:56px;max-height:40vh;resize:vertical;border:1px solid var(--border);background:transparent;color:var(--text);padding:.8rem;border-radius:.7rem;outline:none}
  .bar{display:flex;gap:.6rem}
  .hint{color:var(--muted);font-size:.9rem;text-align:center}
  .typing{display:none;color:var(--muted);font-size:.9rem;gap:.4rem;align-items:center}
  .typing.show{display:flex}
  .dots{display:inline-flex;gap:.2rem}
  .dots span{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.45;animation:b 1.3s infinite}
  .dots span:nth-child(2){animation-delay:.2s} .dots span:nth-child(3){animation-delay:.4s}
  @keyframes b{0%,100%{transform:translateY(0);opacity:.35}50%{transform:translateY(-3px);opacity:.9}}
  .footer{color:var(--muted);text-align:center;padding:.6rem .8rem;font-size:.9rem}
  .small{font-size:.85rem;padding:.3rem .5rem}
  .warn{background:#3b1220;color:#ffd7d7;padding:.6rem;border-radius:.5rem;border:1px solid rgba(255,200,200,.07);font-size:.9rem}
  .status{font-size:.9rem;color:var(--muted);display:flex;gap:.6rem;align-items:center}
  .status .dot{width:10px;height:10px;border-radius:50%}
  .online{background:#16a34a;box-shadow:0 0 8px #16a34a33}
  .offline{background:#c2410c;box-shadow:0 0 8px #c2410c33}
</style>
</head>
<body data-theme="dark">
  <div class="app" role="application" aria-label="Chat h√≠brido">
    <header>
      <div class="title">Chat h√≠brido ‚Äî gpt-4o-mini</div>
      <div class="spacer"></div>
      <div class="status" id="net-status" title="Status da conex√£o">
        <span class="dot offline" id="status-dot"></span>
        <span id="status-text">Offline (usando simulador)</span>
      </div>
      <button id="btn-theme" class="btn small" title="Alternar tema">üåó Tema</button>
      <button id="btn-clear" class="btn small" title="Limpar conversa">üßπ Limpar</button>
      <button id="btn-export" class="btn small" title="Exportar conversa">‚¨áÔ∏è Exportar</button>
    </header>

    <main id="messages" class="messages" aria-live="polite" aria-label="Hist√≥rico de mensagens">
      <div class="empty">üí¨ Comece uma conversa. O chat tentar√° usar a OpenAI online; se n√£o houver, usa uma resposta simulada.</div>
    </main>

    <div class="composer">
      <div id="typing" class="typing" aria-live="polite"><strong>ChatGPT</strong> est√° digitando <span class="dots"><span></span><span></span><span></span></span></div>

      <div class="bar">
        <textarea id="input" placeholder="Escreva sua mensagem‚Ä¶ (Shift+Enter = nova linha)"></textarea>
        <button id="btn-send" class="btn primary">Enviar ‚û§</button>
      </div>

      <div class="hint">Funcionamento: tenta API da OpenAI; se falhar, responde localmente.</div>

      <details style="margin-top:.4rem">
        <summary style="cursor:pointer;color:var(--muted)">üîí API (embutida) ‚Äî somente para testes locais</summary>
        <div style="margin-top:.6rem;display:flex;gap:.6rem;flex-direction:column">
          <div class="warn">CHAVE EMBUTIDA ‚Äî VIS√çVEL NO C√ìDIGO</div>
          <div style="font-size:.9rem;color:var(--muted)"><strong>Endpoint:</strong> https://api.openai.com/v1/chat/completions</div>
          <div style="font-size:.9rem;color:var(--muted)"><strong>Modelo:</strong> gpt-4o-mini</div>
        </div>
      </details>
    </div>

    <div class="footer">H√≠brido: online (API) ‚Üî offline (simulador)</div>
  </div>

  <template id="tpl-msg">
    <div class="msg">
      <div class="avatar" aria-hidden="true"></div>
      <div class="bubble"></div>
      <div class="meta">
        <span class="time"></span>
        <span class="role"></span>
        <span style="margin-left:auto"></span>
      </div>
    </div>
  </template>

<script>
/* ========================
   CONFIGURA√á√ÉO (chave)
   ======================== */
/* VOC√ä PEDIU COM RISCOS: chave vis√≠vel aqui */
const OPENAI_API_KEY = 'SXQxtibo1GIgaiwuAya2sHfyfxoEA9K4djDp0sqXHo_pYNWenO3';
const OPENAI_ENDPOINT = 'https://api.openai.com/v1/chat/completions';
const OPENAI_MODEL = 'gpt-4o-mini';

/* ========================
   UTILIT√ÅRIOS
   ======================== */
const $ = (s, r=document) => r.querySelector(s);
const tpl = $('#tpl-msg').content;
const listEl = $('#messages');
const input = $('#input');
const btnSend = $('#btn-send');
const typingEl = $('#typing');
const statusDot = $('#status-dot');
const statusText = $('#status-text');
const STORE_KEY = 'chat_hybrid_v1';

function nowTime(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function loadMsgs(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }catch{ return [] } }
function saveMsgs(m){ localStorage.setItem(STORE_KEY, JSON.stringify(m)); }

/* ========================
   ESTADO
   ======================== */
let messages = loadMsgs(); // {id, role, content, time}
let working = false;

/* ========================
   RENDER
   ======================== */
function render(){
  listEl.innerHTML = '';
  if(messages.length === 0){
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.textContent = 'üí¨ Comece uma conversa. O chat tentar√° usar a OpenAI online; se n√£o houver, usa uma resposta simulada.';
    listEl.appendChild(empty);
    return;
  }
  for(const m of messages) appendMessageEl(m);
  listEl.scrollTop = listEl.scrollHeight;
}

function appendMessageEl(m){
  const node = tpl.cloneNode(true);
  const root = node.querySelector('.msg');
  root.classList.add(m.role);
  node.querySelector('.avatar').textContent = m.role === 'user' ? 'üë§' : 'ü§ñ';
  node.querySelector('.bubble').innerText = m.content;
  node.querySelector('.time').textContent = m.time || nowTime();
  node.querySelector('.role').textContent = m.role === 'user' ? 'Voc√™' : 'ChatGPT';
  listEl.appendChild(node);
}

/* ========================
   UI Actions
   ======================== */
btnSend.addEventListener('click', sendFromInput);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendFromInput(); }});
$('#btn-clear').addEventListener('click', ()=>{ if(confirm('Limpar toda a conversa?')){ messages=[]; saveMsgs(messages); render(); }});
$('#btn-export').addEventListener('click', ()=>{ const txt = messages.map(m=>`[${m.time}] ${m.role.toUpperCase()}\n${m.content}\n`).join('\n'); const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='conversa-hibrido.txt'; a.click(); URL.revokeObjectURL(a.href); });
$('#btn-theme').addEventListener('click', ()=>{ const cur = document.body.getAttribute('data-theme') || 'dark'; const next = cur==='dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', next); localStorage.setItem('chat_demo_theme', next); });

/* ========================
   Mensagens
   ======================== */
function pushMessage(role, content){
  const m = { id: crypto.randomUUID(), role, content, time: nowTime() };
  messages.push(m); saveMsgs(messages); appendMessageEl(m); listEl.scrollTop = listEl.scrollHeight;
  return m;
}

/* ========================
   Rede / status
   ======================== */
function updateNetworkStatus(){
  const online = navigator.onLine;
  if(online){
    statusDot.classList.remove('offline'); statusDot.classList.add('online');
    statusText.textContent = 'Online (tentar√° usar API)';
  } else {
    statusDot.classList.remove('online'); statusDot.classList.add('offline');
    statusText.textContent = 'Offline (usando simulador)';
  }
}
window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);

/* ========================
   SIMULADOR (fallback)
   ======================== */
function simpleAnswer(q){
  const lower = (q||'').toLowerCase();
  if(/\b(oi|ol√°|bom dia|boa tarde|boa noite)\b/.test(lower)) return 'Ol√°! üëã Vou responder com o modo simulado porque a API n√£o est√° dispon√≠vel agora.';
  if(/\b(quem √© voc√™|quem √© vc|o que voc√™ faz)\b/.test(lower)) return 'Sou um assistente local de demonstra√ß√£o (modo offline). Posso dar instru√ß√µes √∫teis e exemplos, mas n√£o tenho o conhecimento atualizado da nuvem.';
  if(/\b(html|css|javascript|c√≥digo|code)\b/.test(lower)) return 'Para centralizar um elemento, use display:flex; align-items:center; justify-content:center; no container e defina height:100vh.';
  if(/\b(piada|piadas|conte uma piada)\b/.test(lower)) return 'Por que o programador levou o laptop para a geladeira? Porque precisava de mais cache. üòÖ';
  return 'Resposta simulada: entendi "' + (q||'') + '". Se quiser respostas reais, conecte com a OpenAI quando estiver online.';
}

/* streaming de texto simples para efeito */
async function simulatedStreamingAnswer(userText, assistantObj){
  // divide em chunks
  const text = simpleAnswer(userText);
  const parts = [];
  let buf = '';
  for(const ch of text){
    buf += ch;
    if(buf.length > (5 + Math.random()*20)){
      parts.push(buf); buf='';
    }
  }
  if(buf) parts.push(buf);
  for(const p of parts){
    await new Promise(r=>setTimeout(r, 60 + Math.random()*120));
    assistantObj.content += p;
    saveMsgs(messages); // atualiza localStorage
    // atualiza √∫ltimo bal√£o
    const last = listEl.lastElementChild;
    if(last) last.querySelector('.bubble').innerText = assistantObj.content;
    listEl.scrollTop = listEl.scrollHeight;
  }
}

/* ========================
   CHAMADA √Ä API (tenta; se falhar => fallback)
   ======================== */
async function requestReplyHybrid(){
  typingEl.classList.add('show'); working = true;
  try{
    const apiMessages = messages.map(m=>({
      role: m.role === 'user' ? 'user' : (m.role === 'assistant' ? 'assistant' : 'system'),
      content: m.content
    }));
    apiMessages.unshift({ role: 'system', content: 'Voc√™ √© um assistente √∫til e sucinto.' });

    // tentativa online (com timeout)
    const payload = { model: OPENAI_MODEL, messages: apiMessages, max_tokens: 1000, temperature: 0.2 };
    const controller = new AbortController();
    const timeoutId = setTimeout(()=>controller.abort(), 20000); // 20s timeout

    let res;
    try{
      res = await fetch(OPENAI_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + OPENAI_API_KEY },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
    }catch(fetchErr){
      // falha de rede / timeout -> fallback
      console.warn('Fetch falhou (network/timeout):', fetchErr);
      res = null;
    } finally {
      clearTimeout(timeoutId);
    }

    if(!res || !res.ok){
      // fallback: resposta simulada
      const assistantObj = pushMessage('assistant', '');
      await simulatedStreamingAnswer(messages[messages.length-1].content, assistantObj);
      return;
    }

    const data = await res.json();
    // parse robusto: suportar diferentes formatos de retorno
    let assistantText = '';
    if(Array.isArray(data.choices) && data.choices.length){
      const c = data.choices[0];
      if(c.message && (c.message.content !== undefined)) assistantText = c.message.content;
      else if(c.text !== undefined) assistantText = c.text;
      else if(c.delta && c.delta.content) assistantText = c.delta.content;
    } else if(data.error && data.error.message){
      throw new Error(data.error.message);
    }

    if(!assistantText){
      // se resposta vazia, usa fallback simulador
      const assistantObj = pushMessage('assistant', '');
      await simulatedStreamingAnswer(messages[messages.length-1].content, assistantObj);
      return;
    }

    // caso normal: adiciona resposta da API (sem streaming)
    pushMessage('assistant', assistantText);
  }catch(err){
    console.error('requestReplyHybrid erro:', err);
    // em erro inesperado, fallback
    const assistantObj = pushMessage('assistant', '');
    await simulatedStreamingAnswer(messages[messages.length-1].content, assistantObj);
  }finally{
    typingEl.classList.remove('show'); working = false;
  }
}

/* ========================
   Envio da mensagem do usu√°rio
   ======================== */
async function sendFromInput(){
  const text = input.value.trim();
  if(!text || working) return;
  input.value = '';
  pushMessage('user', text);
  // atualiza status (online/offline)
  updateNetworkStatus();
  // tenta usar API; se falhar, fallback autom√°tico dentro da fun√ß√£o
  await requestReplyHybrid();
}

/* ========================
   Inicializa√ß√£o
   ======================== */
(function init(){
  const savedTheme = localStorage.getItem('chat_demo_theme');
  if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
  updateNetworkStatus();
  render();
})();

</script>
</body>
</html>

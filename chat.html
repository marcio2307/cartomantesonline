<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat (gpt-4o-mini) ‚Äî Demo com chave embutida</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel-2:#111827; --text:#e5e7eb;
      --muted:#94a3b8; --accent:#22c55e; --border:#1f2937;
      --bubble-user:#1f2937; --bubble-assistant:#0a0f1d;
    }
    [data-theme="light"]{
      --bg:#f7f7fb; --panel:#fff; --panel-2:#f3f4f6; --text:#111827; --muted:#6b7280; --accent:#16a34a; --border:#e5e7eb;
      --bubble-user:#e5e7eb; --bubble-assistant:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;height:100vh}
    header{display:flex;align-items:center;gap:.75rem;padding:.9rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2))}
    .title{font-weight:700}
    .spacer{flex:1}
    .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:.45rem .7rem;border-radius:.6rem;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0b0b}
    .messages{flex:1;overflow:auto;padding:1rem;scroll-behavior:smooth}
    .empty{text-align:center;opacity:.8;margin-top:18vh}
    .msg{display:grid;grid-template-columns:auto 1fr;gap:.6rem 0;align-items:flex-start;margin-bottom:1rem}
    .msg .avatar{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:700}
    .msg.user .avatar{background:#334155}
    .msg.assistant .avatar{background:#063b2d}
    .bubble{grid-column:2/span 1;padding:.8rem 1rem;border-radius:1rem;background:var(--bubble-assistant);border:1px solid var(--border);white-space:pre-wrap}
    .msg.user .bubble{background:var(--bubble-user)}
    .meta{grid-column:2/span 1;color:var(--muted);font-size:.82rem;margin-top:.22rem;display:flex;gap:.6rem;align-items:center}
    .composer{border-top:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));padding:.8rem;display:grid;gap:.6rem}
    textarea{flex:1;min-height:56px;max-height:40vh;resize:vertical;border:1px solid var(--border);background:transparent;color:var(--text);padding:.8rem;border-radius:.7rem;outline:none}
    .bar{display:flex;gap:.6rem}
    .hint{color:var(--muted);font-size:.9rem;text-align:center}
    .typing{display:none;color:var(--muted);font-size:.9rem;gap:.4rem;align-items:center}
    .typing.show{display:flex}
    .dots{display:inline-flex;gap:.2rem}
    .dots span{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.45;animation:b 1.3s infinite}
    .dots span:nth-child(2){animation-delay:.2s} .dots span:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,100%{transform:translateY(0);opacity:.35}50%{transform:translateY(-3px);opacity:.9}}
    .footer{color:var(--muted);text-align:center;padding:.6rem .8rem;font-size:.9rem}
    .small{font-size:.85rem;padding:.3rem .5rem}
    @media (max-width:600px){header{padding:.6rem}.small{display:none}}
    .warn{background:#3b1220;color:#ffd7d7;padding:.6rem;border-radius:.5rem;border:1px solid rgba(255,200,200,.07);font-size:.9rem}
  </style>
</head>
<body data-theme="dark">
  <div class="app" role="application" aria-label="Chat GPT local">
    <header>
      <div class="title">ChatGPT ‚Äî gpt-4o-mini (chave embutida)</div>
      <div class="spacer"></div>
      <button id="btn-theme" class="btn small" title="Alternar tema">üåó Tema</button>
      <button id="btn-clear" class="btn small" title="Limpar conversa">üßπ Limpar</button>
      <button id="btn-export" class="btn small" title="Exportar conversa">‚¨áÔ∏è Exportar</button>
    </header>

    <main id="messages" class="messages" aria-live="polite" aria-label="Hist√≥rico de mensagens">
      <div class="empty">üí¨ Comece uma conversa. Sua conversa fica salva somente neste navegador.</div>
    </main>

    <div class="composer">
      <div id="typing" class="typing" aria-live="polite"><strong>ChatGPT</strong> est√° digitando <span class="dots"><span></span><span></span><span></span></span></div>

      <div class="bar">
        <textarea id="input" placeholder="Escreva sua mensagem‚Ä¶ (Shift+Enter = nova linha)"></textarea>
        <button id="btn-send" class="btn primary">Enviar ‚û§</button>
      </div>

      <div class="hint">Arquivo com chave embutida (apenas para testes locais). N√£o publique este arquivo.</div>

      <details style="margin-top:.4rem">
        <summary style="cursor:pointer;color:var(--muted)">üîí Informa√ß√£o da API (embutida)</summary>
        <div style="margin-top:.6rem;display:flex;gap:.6rem;flex-direction:column">
          <div class="warn">CHAVE EMBUTIDA NO ARQUIVO ‚Äî VIS√çVEL A QUALQUER UM QUE ABRIR ESSE HTML.</div>
          <div style="font-size:.9rem;color:var(--muted)"><strong>Endpoint:</strong> https://api.openai.com/v1/chat/completions</div>
          <div style="font-size:.9rem;color:var(--muted)"><strong>Modelo:</strong> gpt-4o-mini</div>
        </div>
      </details>
    </div>

    <div class="footer">Demo local ‚Äî use com responsabilidade</div>
  </div>

  <template id="tpl-msg">
    <div class="msg">
      <div class="avatar" aria-hidden="true"></div>
      <div class="bubble"></div>
      <div class="meta">
        <span class="time"></span>
        <span class="role"></span>
        <span style="margin-left:auto"></span>
      </div>
    </div>
  </template>

  <script>
  // ============================
  // CONFIGURA√á√ÉO (chave embutida)
  // ============================
  // VOC√ä solicitou chave embutida ‚Äî aqui est√° (vis√≠vel no HTML).
  const OPENAI_API_KEY = 'SXQxtibo1GIgaiwuAya2sHfyfxoEA9K4djDp0sqXHo_pYNWenO3';
  const OPENAI_ENDPOINT = 'https://api.openai.com/v1/chat/completions';
  const OPENAI_MODEL = 'gpt-4o-mini';

  // ============================
  // UTILIT√ÅRIOS
  // ============================
  const $ = (s, root=document) => root.querySelector(s);
  const tpl = $('#tpl-msg').content;
  const listEl = $('#messages');
  const input = $('#input');
  const btnSend = $('#btn-send');
  const typingEl = $('#typing');

  const STORE_KEY = 'chat_direct_demo_v1';
  function nowTime(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  function loadMsgs(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }catch{ return [] } }
  function saveMsgs(m){ localStorage.setItem(STORE_KEY, JSON.stringify(m)); }

  // ============================
  // ESTADO
  // ============================
  let messages = loadMsgs(); // array de {id, role, content, time}
  let working = false;

  // ============================
  // RENDER
  // ============================
  function render(){
    listEl.innerHTML = '';
    if(messages.length === 0){
      const empty = document.createElement('div'); empty.className='empty'; empty.textContent='üí¨ Comece uma conversa. Sua conversa fica salva somente neste navegador.'; listEl.appendChild(empty); return;
    }
    for(const m of messages) appendMessageEl(m);
    listEl.scrollTop = listEl.scrollHeight;
  }

  function appendMessageEl(m){
    const node = tpl.cloneNode(true);
    const root = node.querySelector('.msg');
    root.classList.add(m.role);
    node.querySelector('.avatar').textContent = m.role === 'user' ? 'üë§' : 'ü§ñ';
    node.querySelector('.bubble').innerText = m.content;
    node.querySelector('.time').textContent = m.time || nowTime();
    node.querySelector('.role').textContent = m.role === 'user' ? 'Voc√™' : 'ChatGPT';
    listEl.appendChild(node);
  }

  // ============================
  // A√á√ïES UI
  // ============================
  btnSend.addEventListener('click', sendFromInput);
  input.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendFromInput(); } });

  $('#btn-clear').addEventListener('click', ()=>{ if(confirm('Limpar toda a conversa?')){ messages=[]; saveMsgs(messages); render(); }});
  $('#btn-export').addEventListener('click', ()=>{ const txt = messages.map(m=>`[${m.time}] ${m.role.toUpperCase()}\n${m.content}\n`).join('\n'); const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='conversa.txt'; a.click(); URL.revokeObjectURL(a.href); });
  $('#btn-theme').addEventListener('click', ()=>{ const cur = document.body.getAttribute('data-theme') || 'dark'; const next = cur==='dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', next); localStorage.setItem('chat_demo_theme', next); });

  // ============================
  // MENSAGENS
  // ============================
  function pushMessage(role, content){
    const m = { id: crypto.randomUUID(), role, content, time: nowTime() };
    messages.push(m); saveMsgs(messages); appendMessageEl(m); listEl.scrollTop = listEl.scrollHeight;
    return m;
  }

  async function sendFromInput(){
    const text = input.value.trim();
    if(!text || working) return;
    input.value = '';
    pushMessage('user', text);
    await requestReply();
  }

  // ============================
  // CHAMADA √Ä API (s√≠ncrona)
  // ============================
  async function requestReply(){
    // monta hist√≥rico como mensagens para API
    typingEl.classList.add('show'); working = true;
    try{
      // Converte nosso hist√≥rico para o formato esperado: role/content
      const apiMessages = messages.map(m=>({ role: m.role === 'user' ? 'user' : (m.role === 'assistant' ? 'assistant' : 'system'), content: m.content }));
      // Adiciona instru√ß√£o do sistema (concisa)
      apiMessages.unshift({ role: 'system', content: 'Voc√™ √© um assistente √∫til e sucinto.' });

      // Chamada POST
      const payload = {
        model: OPENAI_MODEL,
        messages: apiMessages,
        max_tokens: 1000,
        temperature: 0.2
      };

      const res = await fetch(OPENAI_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + OPENAI_API_KEY
        },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const txt = await res.text().catch(()=>'');
        throw new Error('Erro na API: ' + res.status + ' ‚Äî ' + (txt || res.statusText));
      }

      const data = await res.json();

      // segura: verifica path esperado
      let assistantText = '';
      if(Array.isArray(data.choices) && data.choices.length){
        const c = data.choices[0];
        if(c.message && (c.message.content !== undefined)){
          // padr√£o Chat Completions (mensagem completa)
          assistantText = c.message.content;
        }else if(c.delta && c.delta.content){
          // fallback (caso de stream): junta
          assistantText = c.delta.content;
        }else if(typeof c.text === 'string'){
          assistantText = c.text;
        }
      } else if (typeof data.error === 'object' && data.error.message) {
        throw new Error('API retornou erro: ' + data.error.message);
      }

      if(!assistantText) assistantText = '(Resposta vazia da API)';

      pushMessage('assistant', assistantText);
    }catch(err){
      console.error(err);
      pushMessage('assistant', 'Erro: ' + (err.message || String(err)));
    }finally{
      typingEl.classList.remove('show'); working = false;
    }
  }

  // ============================
  // Inicializa√ß√£o
  // ============================
  (function init(){
    const savedTheme = localStorage.getItem('chat_demo_theme');
    if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
    render();
  })();
  </script>
</body>
</html>
